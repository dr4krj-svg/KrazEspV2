--[[
    KrazEsp V2 - PREMIUM MONITOR EDITION (TRACER FIX)
    Ativação: [ X ] | Cor: [ P ]
]]

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local Stats = game:GetService("Stats")
local Camera = workspace.CurrentCamera
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

-- Limpeza de desenhos fantasmas de execuções anteriores (Prevenção de Bugs)
if _G.KrazClean then _G.KrazClean() end

-- FUNÇÃO CONVIDAR DISCORD
local function DiscordInvite()
    local inviteCode = "hkRYADZM5z"
    local http = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
    if http then
        http({
            Url = "http://127.0.0.1:6463/rpc?v=1",
            Method = "POST",
            Headers = {["Content-Type"] = "application/json", ["Origin"] = "https://discord.com"},
            Body = HttpService:JSONEncode({cmd = "INVITE_BROWSER", args = {code = inviteCode}, nonce = HttpService:GenerateGUID(false)}),
        })
    end
end
DiscordInvite()

local LocalPlayer = Players.LocalPlayer
local startTime = os.time()

local settings = {
    enabled = false,
    espColor = Color3.fromRGB(160, 32, 240),
    colors = {
        Color3.fromRGB(160, 32, 240),
        Color3.fromRGB(255, 48, 48),
        Color3.fromRGB(0, 255, 120),
        Color3.fromRGB(0, 160, 255),
        Color3.fromRGB(255, 200, 0)
    },
    colorIndex = 1
}

-- Interface Principal
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "KrazEsp_V2_Final"
screenGui.Parent = CoreGui
screenGui.ResetOnSpawn = false

-- BOTÃO MINIMIZAR (K)
local minBtn = Instance.new("TextButton")
minBtn.Size = UDim2.new(0, 55, 0, 55)
minBtn.Position = UDim2.new(0.02, 0, 0.15, 0)
minBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
minBtn.Text = "K"
minBtn.TextColor3 = settings.espColor
minBtn.Font = Enum.Font.GothamBold
minBtn.TextSize = 26
minBtn.Parent = screenGui
Instance.new("UICorner", minBtn).CornerRadius = UDim.new(0, 12)
local btnStroke = Instance.new("UIStroke", minBtn)
btnStroke.Color = settings.espColor
btnStroke.Thickness = 2.5

local btnGlow = Instance.new("ImageLabel")
btnGlow.BackgroundTransparency = 1
btnGlow.Position = UDim2.new(0, -10, 0, -10)
btnGlow.Size = UDim2.new(1, 20, 1, 20)
btnGlow.Image = "rbxassetid://4996891919"
btnGlow.ImageColor3 = settings.espColor
btnGlow.ImageTransparency = 0.6
btnGlow.Parent = minBtn

-- Painel Principal
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 240, 0, 330)
mainFrame.Position = UDim2.new(0.05, 0, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 15)
local mainStroke = Instance.new("UIStroke", mainFrame)
mainStroke.Color = settings.espColor
mainStroke.Thickness = 2

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 50)
title.BackgroundTransparency = 1
title.Text = "KrazEsp V2"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 20
title.Parent = mainFrame

-- LABELS DE INFO
local function createLabel(pos, align)
    local l = Instance.new("TextLabel")
    l.Size = UDim2.new(0.5, -15, 0, 20); l.Position = pos; l.BackgroundTransparency = 1
    l.TextColor3 = Color3.fromRGB(200, 200, 200); l.Font = Enum.Font.GothamSemibold; l.TextSize = 10
    l.TextXAlignment = align; l.Parent = mainFrame
    return l
end
local userLabel = createLabel(UDim2.new(0, 15, 0, 45), Enum.TextXAlignment.Left)
userLabel.Text = "USER: " .. LocalPlayer.Name
local timeLabel = createLabel(UDim2.new(0.5, 0, 0, 45), Enum.TextXAlignment.Right)
local fpsLabel = createLabel(UDim2.new(0, 15, 0, 60), Enum.TextXAlignment.Left)
local pingLabel = createLabel(UDim2.new(0.5, 0, 0, 60), Enum.TextXAlignment.Right)

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0, 200, 0, 48); toggleBtn.Position = UDim2.new(0.5, -100, 0, 95)
toggleBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30); toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleBtn.Font = Enum.Font.GothamBold; toggleBtn.TextSize = 14; toggleBtn.Parent = mainFrame
Instance.new("UICorner", toggleBtn)

local colorBtn = Instance.new("TextButton")
colorBtn.Size = UDim2.new(0, 200, 0, 48); colorBtn.Position = UDim2.new(0.5, -100, 0, 150)
colorBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30); colorBtn.Text = "MUDAR COR"
colorBtn.TextColor3 = Color3.fromRGB(255, 255, 255); colorBtn.Font = Enum.Font.GothamBold
colorBtn.TextSize = 14; colorBtn.Parent = mainFrame
Instance.new("UICorner", colorBtn)

-- INSTRUÇÕES
local line = Instance.new("Frame")
line.Size = UDim2.new(0.8, 0, 0, 1); line.Position = UDim2.new(0.1, 0, 0, 215)
line.BackgroundColor3 = Color3.fromRGB(50, 50, 50); line.BorderSizePixel = 0; line.Parent = mainFrame

local instrBody = Instance.new("TextLabel")
instrBody.Size = UDim2.new(1, 0, 0, 70); instrBody.Position = UDim2.new(0, 0, 0, 230)
instrBody.BackgroundTransparency = 1
instrBody.Text = "ATALHOS:\n[ X ] ATIVAR / DESATIVAR\n[ P ] ALTERNAR CORES"
instrBody.TextColor3 = Color3.fromRGB(180, 180, 180); instrBody.Font = Enum.Font.GothamBold
instrBody.TextSize = 11; instrBody.Parent = mainFrame

-----------------------------------------------------------
-- LÓGICA E FIX DO TRACER
-----------------------------------------------------------
local allTracers = {}

local function removeTracer(p)
    if allTracers[p] then
        allTracers[p].Visible = false
        allTracers[p]:Remove()
        allTracers[p] = nil
    end
end

-- Limpa tudo ao fechar/reiniciar
_G.KrazClean = function()
    for p, _ in pairs(allTracers) do removeTracer(p) end
    if screenGui then screenGui:Destroy() end
end

local function updateUI()
    local color = settings.espColor
    toggleBtn.Text = settings.enabled and "ESP: ATIVO" or "ESP: INATIVO"
    toggleBtn.BackgroundColor3 = settings.enabled and Color3.fromRGB(45, 120, 45) or Color3.fromRGB(120, 45, 45)
    
    TweenService:Create(mainStroke, TweenInfo.new(0.3), {Color = color}):Play()
    TweenService:Create(minBtn, TweenInfo.new(0.3), {TextColor3 = color}):Play()
    TweenService:Create(btnStroke, TweenInfo.new(0.3), {Color = color}):Play()
    btnGlow.ImageColor3 = color
    userLabel.TextColor3 = color
    timeLabel.TextColor3 = color
end

local function toggle()
    settings.enabled = not settings.enabled
    updateUI()
    -- Se desligar, limpa visualmente na hora
    if not settings.enabled then
        for _, t in pairs(allTracers) do t.Visible = false end
    end
end

UserInputService.InputBegan:Connect(function(i, p)
    if p then return end
    if i.KeyCode == Enum.KeyCode.X then toggle()
    elseif i.KeyCode == Enum.KeyCode.P then 
        settings.colorIndex = (settings.colorIndex % #settings.colors) + 1
        settings.espColor = settings.colors[settings.colorIndex]
        updateUI()
    end
end)

toggleBtn.MouseButton1Click:Connect(toggle)
colorBtn.MouseButton1Click:Connect(function()
    settings.colorIndex = (settings.colorIndex % #settings.colors) + 1
    settings.espColor = settings.colors[settings.colorIndex]
    updateUI()
end)
minBtn.MouseButton1Click:Connect(function() mainFrame.Visible = not mainFrame.Visible end)

-----------------------------------------------------------
-- RENDERIZAÇÃO (REFEITA PARA EVITAR BUGS)
-----------------------------------------------------------
RunService.RenderStepped:Connect(function()
    -- FPS, Ping e Tempo
    fpsLabel.Text = "FPS: " .. math.floor(1/RunService.RenderStepped:Wait()) -- FPS mais preciso
    pingLabel.Text = "PING: " .. math.floor(Stats.Network.ServerStatsItem["Data Ping"]:GetValue()) .. "ms"
    local s = os.time() - startTime
    timeLabel.Text = string.format("%02d:%02d:%02d", math.floor(s/3600), math.floor((s%3600)/60), s%60)

    for _, player in pairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        
        local char = player.Character
        local tracer = allTracers[player]
        
        -- Criar tracer se não existir
        if not tracer then
            tracer = Drawing.new("Line")
            tracer.Thickness = 1.5
            allTracers[player] = tracer
        end

        if settings.enabled and char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
            local root = char.HumanoidRootPart
            local screenPos, onScreen = Camera:WorldToViewportPoint(root.Position)
            
            if onScreen then
                tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
                tracer.To = Vector2.new(screenPos.X, screenPos.Y)
                tracer.Color = settings.espColor
                tracer.Visible = true
            else
                tracer.Visible = false
            end
            
            -- Highlight
            local hl = char:FindFirstChild("KrazHighlight") or Instance.new("Highlight", char)
            hl.Name = "KrazHighlight"
            hl.OutlineColor = settings.espColor
            hl.FillTransparency = 1
            hl.Enabled = true
        else
            -- Se o player morreu ou saiu do alcance ou o ESP tá OFF
            tracer.Visible = false
            if char and char:FindFirstChild("KrazHighlight") then
                char.KrazHighlight.Enabled = false
            end
        end
    end
end)

-- Limpeza quando alguém sai do servidor
Players.PlayerRemoving:Connect(removeTracer)

-- Drag System
local function drag(obj)
    local dragging, dragStart, startPos
    obj.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true; dragStart = input.Position; startPos = obj.Position
        end
    end)
    obj.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            obj.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    obj.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
end
drag(mainFrame); drag(minBtn)

updateUI()
